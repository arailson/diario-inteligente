name: DiÃ¡rio Inteligente - AutomaÃ§Ã£o Completa

# Executa:
# - Segunda, Quarta e Sexta Ã s 20h (formulÃ¡rios diÃ¡rios)
# - SÃ¡bado Ã s 9h (relatÃ³rio semanal)
on:
  schedule:
    # Cron: minuto hora dia mÃªs dia-da-semana
    # 0 23 * * 1,3,5 = Segunda, Quarta, Sexta Ã s 23h UTC (20h BrasÃ­lia)
    # 0 12 * * 6 = SÃ¡bado Ã s 12h UTC (9h BrasÃ­lia)
    - cron: '0 23 * * 1,3,5'  # FormulÃ¡rios diÃ¡rios
    - cron: '0 12 * * 6'      # RelatÃ³rio semanal
  
  # Permite execuÃ§Ã£o manual para testes
  workflow_dispatch:
    inputs:
      action_type:
        description: 'Tipo de aÃ§Ã£o (daily_form ou weekly_report)'
        required: true
        type: choice
        options:
          - daily_form
          - weekly_report
      test_email:
        description: 'Email para teste (opcional)'
        required: false
        type: string

jobs:
  daily-form:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 23 * * 1,3,5' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action_type == 'daily_form')
    
    steps:
    - name: ðŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ðŸ“¦ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ðŸ”§ Configurar variÃ¡veis de ambiente
      run: |
        echo "DATABASE_PATH=data/reviews.db" >> $GITHUB_ENV
        echo "EMAIL_USER=${{ secrets.EMAIL_USER }}" >> $GITHUB_ENV
        echo "EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}" >> $GITHUB_ENV
        echo "EMAIL_SMTP_SERVER=smtp.gmail.com" >> $GITHUB_ENV
        echo "EMAIL_SMTP_PORT=587" >> $GITHUB_ENV
        echo "DAILY_FORM_EMAIL=${{ secrets.DAILY_FORM_EMAIL }}" >> $GITHUB_ENV
    
    - name: ðŸ“ Enviar formulÃ¡rio diÃ¡rio
      run: |
        python daily_form.py
      env:
        DAILY_FORM_EMAIL: ${{ github.event.inputs.test_email || secrets.DAILY_FORM_EMAIL }}
    
    - name: âœ… FormulÃ¡rio enviado
      run: |
        echo "ðŸ“ FormulÃ¡rio diÃ¡rio enviado com sucesso!"
        echo "ðŸ“… Data: $(date)"
        echo "ðŸ“§ Email: ${{ secrets.DAILY_FORM_EMAIL }}"

  weekly-report:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 12 * * 6' || (github.event_name == 'workflow_dispatch' && github.event.inputs.action_type == 'weekly_report')
    
    steps:
    - name: ðŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
    
    - name: ðŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ðŸ“¦ Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ðŸ”§ Configurar variÃ¡veis de ambiente
      run: |
        echo "DATABASE_PATH=data/reviews.db" >> $GITHUB_ENV
        echo "EMAIL_USER=${{ secrets.EMAIL_USER }}" >> $GITHUB_ENV
        echo "EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}" >> $GITHUB_ENV
        echo "EMAIL_SMTP_SERVER=smtp.gmail.com" >> $GITHUB_ENV
        echo "EMAIL_SMTP_PORT=587" >> $GITHUB_ENV
        echo "WEEKLY_REPORT_EMAIL=${{ secrets.WEEKLY_REPORT_EMAIL }}" >> $GITHUB_ENV
    
    - name: ðŸ“Š Executar relatÃ³rio semanal
      run: |
        python weekly_report.py
      env:
        WEEKLY_REPORT_EMAIL: ${{ github.event.inputs.test_email || secrets.WEEKLY_REPORT_EMAIL }}
    
    - name: âœ… RelatÃ³rio enviado
      run: |
        echo "ðŸŽ‰ RelatÃ³rio semanal enviado com sucesso!"
        echo "ðŸ“… Data: $(date)"
        echo "ðŸ“§ Email: ${{ secrets.WEEKLY_REPORT_EMAIL }}"
